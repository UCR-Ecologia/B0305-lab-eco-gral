---
subtitle: "B0305 -- Lab Eco Gral"
title: "<font style='font-size:1em;'>Dise√±o experimental, (pseudo)replicaci√≥n, poder estad√≠stico</font>"
author: Prof. T Nakov
institute: 'Escuela de Biologia, Universidad de Costa Rica'
date: 01 August 2025
date-meta: 01 August 2025
date-format: "DD MMM YYYY"
toc: true
toc-depth: 1
toc-title: "Que vamos a ver:"
center-title-slide: false
from: markdown+emoji
format:
  revealjs: 
    fig-responsive: true
    theme: simple
    slide-number: true
    mouse-wheel: false
    preview-links: auto
    incremental: false
    logo: /figures/icons/course_favicon.png
    css: /css/styles_slides.css
    footer: 'B0305 -- Lab Eco Gral'
execute:
  echo: true
  cache: false
---

## Dise√±o experimental

---

## Por qu√© importa el dise√±o experimental

- Ecolog√≠a = sistemas complejos y variables  
- Mal dise√±o ‚Üí conclusiones inv√°lidas, esfuerzo desperdiciado  
- Buen dise√±o ‚Üí inferencia m√°s s√≥lida, capacidad de generalizar  

---

::: {.columns}
::: {.column}
::: {.fragment}
- **Dise√±o experimental**  
  - El investigador manipula tratamientos (ej. sombreado vs sin sombreado).  
  - Inferencia m√°s fuerte sobre causa-efecto. Requiere control de factores confusores.  
:::
:::
::: {.column}
::: {.fragment}
- **Dise√±o natural**  
  - El investigador aprovecha la variaci√≥n natural (ej. arroyos soleados vs sombreados).  
  - No hay asignaci√≥n verdadera de tratamientos   
:::

:::
::: 

::: {.fragment}
::: {.callout-note title="¬°Ojo!"}
Incluso sin manipulaci√≥n, es necesaria una definici√≥n clara de *unidades experimentales* y *replicaci√≥n*.
:::
:::

---

## Dise√±o Factorial

- **Definici√≥n:** Se prueban todas las combinaciones de factores.  
- Ejemplo: Dos factores ‚Üí luz (alta/baja) √ó nutrientes (altos/bajos)  
  - Tratamientos = 2 √ó 2 = 4 combinaciones  
- Ventaja: puede detectar **efectos de interacci√≥n** (c√≥mo se combinan los factores).  
<!-- - Limitaci√≥n: crece r√°pidamente con el n√∫mero de factores.  -->

---

```{r}
#| label: fig-factorial
#| fig-cap: "2√ó2 factorial design schematic: Light √ó Nutrients."
#| fig-width: 10
#| fig-height: 6
#| echo: false
library(ggplot2)

# Data for a 2x2 factorial tile schematic
df_fact <- expand.grid(Light = c("Low Light","High Light"),
                       Nutrients = c("Low Nutrients","High Nutrients"))
df_fact$Treatment <- paste(df_fact$Light, df_fact$Nutrients, sep="\n")

# Plot
ggplot(df_fact, aes(x = Nutrients, y = Light)) +
  geom_tile(fill = "steelblue", color = "white", linewidth = 0.6) +
  geom_text(aes(label = Treatment), fontface = "bold", size = 8) +
  scale_y_discrete(limits = rev) +
  coord_equal() +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 20) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(margin = margin(t = 6)),
        axis.text.y = element_text(margin = margin(r = 6)))
```

---

## Bloques

- **Definici√≥n:** Agrupar unidades experimentales en bloques que comparten condiciones similares.  
- Ejemplo: La fertilidad del suelo var√≠a a trav√©s de un campo ‚Üí cada bloque contiene todos los tratamientos.  
- Prop√≥sito: controlar fuentes conocidas de variaci√≥n.  
- An√°lisis: el bloque se incluye como factor en el modelo (aleatorio o fijo).  

**Idea clave:** Los bloques reducen el *ruido* de la heterogeneidad.  

---

```{r}
#| label: fig-blocking
#| fig-cap: "Randomized complete block design: each block contains all treatments."
#| fig-width: 10
#| fig-height: 6
#| echo: false
library(dplyr)
library(tidyr)
set.seed(42)

treatments <- c("Control","Light","Nutrients","Light+Nutrients")
blocks <- paste("Block", 1:3)

# Create a layout with randomized treatment order within each block
df_block <- expand.grid(Block = blocks, Plot = 1:length(treatments)) %>%
  group_by(Block) %>%
  mutate(Treatment = sample(treatments, size = n(), replace = FALSE)) %>%
  # mutate(Treatment = treatments) %>%
  ungroup() %>%
  mutate(Block = factor(Block, levels = blocks),
         PlotPos = Plot)

# Plot as rows = blocks, columns = plots
ggplot(df_block, aes(x = PlotPos, y = Block, fill = Treatment, label = Treatment)) +
  geom_tile(color = "white", linewidth = 0.6, height = 0.8) +
  geom_text(size = 6, fontface = "bold", color = "black") +
  scale_x_continuous(breaks = 1:4, labels = paste("Plot", 1:4)) +
  scale_fill_brewer(palette = "Set2") +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 25) +
  theme(panel.grid = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(margin = margin(t = 6)),
        axis.text.y = element_text(margin = margin(r = 6)))
```

---

## Aleatorizaci√≥n

- **Definici√≥n:** Asignaci√≥n aleatoria de tratamientos a unidades experimentales.  
- Prop√≥sito: evita sesgo sistem√°tico.  
<!-- - Asegura que los efectos del tratamiento no se confundan con variables ocultas.   -->
- Puede ser completa o restringida (dentro de bloques).  

**Ejemplo:** Asignar aleatoriamente sombreado vs control a estanques, no solo "primera mitad sombreada, segunda mitad control."

---

```{r}
#| label: fig-randomization
#| fig-cap: "Randomized assignment of treatments on a field grid (within blocks)."
#| fig-width: 10
#| fig-height: 10
#| echo: false
library(dplyr)
library(ggplot2)
set.seed(123)

# Grid layout (e.g., 4 columns √ó 6 rows), with 3 horizontal blocks
n_cols <- 4
n_rows <- 6
treats <- c("Control","Light","Nutrients","Light+Nutrients")

grid <- expand.grid(col = 1:n_cols, row = 1:n_rows) %>%
  mutate(Block = cut(row, breaks = c(0,2,4,6), labels = c("Block 1","Block 2","Block 3")))

# Randomize treatments within each block with near-equal counts
assign_block <- function(n, levels) {
  rep_len(sample(levels), n) |> sample(n)  # shuffle
}

df_rand <- grid %>%
  group_by(Block) %>%
  mutate(Treatment = assign_block(n(), treats)) %>%
  ungroup()

# Plot grid with block facets (or block borders)
ggplot(df_rand, aes(x = col, y = row, fill = Treatment, label = substr(Treatment,1,1))) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(size = 8, fontface = "bold", color = "black") +
  scale_y_reverse(breaks = 1:n_rows) +
  scale_x_continuous(breaks = 1:n_cols) +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "Column", y = "Row") +
  theme_minimal(base_size = 25) +
  theme(panel.grid = element_blank(),
        legend.position = "bottom") +
  facet_wrap(~ Block, ncol = 1, scales = "free_y")
```

---

## Mensajes claves {.dark-slide}

- **Dise√±o factorial**: probar m√∫ltiples factores y sus interacciones.  
- **Bloques**: controlar variaci√≥n agrupando unidades similares.  
- **Aleatorizaci√≥n**: protegerse contra sesgo.  

<!-- **Mejor pr√°ctica:** combinar los tres cuando sea posible ‚Üí experimentos robustos e interpretables.   -->

---

## Replicaci√≥n y pseudoeplicaci√≥n

---


## Conceptos fundamentales

::: {.fragment}
- **Tratamiento**: Lo que se manipula  
- **Unidad Experimental**: La unidad m√°s peque√±a que puede recibir independientemente un tratamiento  
- **Replicaci√≥n**: M√∫ltiples unidades experimentales independientes por tratamiento  
:::

::: {.fragment}
::: {.callout-note title="¬°Ojo!"}
Replicaci√≥n = unidades experimentales, *no* muestras.
:::
:::

---

## Replicaci√≥n

- Prop√≥sito: estimar variabilidad, probar hip√≥tesis confiablemente  
- Tipos:  
  - *Replicaci√≥n verdadera*: unidades independientes (20 plantas)  
  - *Replicaci√≥n t√©cnica*: medidas repetidas de la misma unidad (20 hojas de 1 planta)  
- Regla pr√°ctica: Replicaci√≥n = n√∫mero de unidades independientes

---

![Replicaci√≥n verdadera vs pseudo replicaci√≥n](figures/replication.png)

---

![Replicaci√≥n verdadera vs pseudo replicaci√≥n](figures/replication2.jpeg)

<!-- ---

## Ejemplos

- Medir 20 hojas de 1 planta ‚Üí **n = ?**  
- Medir 1 hoja de cada una de 20 plantas ‚Üí **n = ?**
- Medir crecimiento de algas despu√©s de adici√≥n de nutrientes 5 d√≠as seguidos ‚Üí **n = ?**
- Contar l√≠quenes en 4 lados de 1 √°rbol ‚Üí **n = ?** -->


---

<!-- ## Tipos de Pseudoreplicaci√≥n

- **Simple**: 1 unidad experimental por tratamiento medida m√∫ltiples veces 
- **Temporal**: medidas repetidas en el tiempo usadas como r√©plicas  

--- -->

## Evitando la pseudoreplicaci√≥n

- M√∫ltiples unidades independientes por tratamiento  
- Asignaci√≥n aleatoria de tratamientos  
- Bloques para controlar la variaci√≥n  
- Modelos jer√°rquicos / mixtos para datos anidados  

---

## Mensajes clave {.dark-slide}

- Replicaci√≥n = unidades independientes, **no** medidas repetidas  
- La pseudoreplicaci√≥n es com√∫n pero evitable  
- Reconocer cuando la replicaci√≥n completa es imposible  

---

## Poder Estad√≠stico: Introducci√≥n

::: {.fragment}
- **Poder estad√≠stico** = probabilidad de detectar un efecto si verdaderamente existe  
- Poder = 1 ‚Äì Œ≤  
  - Œ≤ (Error Tipo II): fallar en rechazar una hip√≥tesis nula cuando esta falsa  
- Meta com√∫n: **80% de poder**  
:::

::: {.fragment}
::: {.callout-note title="¬°Ojo!"}
Alto poder = buena oportunidad de detectar efectos biol√≥gicamente significativos.
:::
:::

---

<!-- ## Por qu√© importa el an√°lisis de poder

- La ecolog√≠a a menudo trata con alta variabilidad  
- Muy pocas r√©plicas ‚Üí falsos negativos (perder efectos reales)  
- Demasiadas r√©plicas ‚Üí tiempo, esfuerzo y recursos desperdiciados  
- El an√°lisis de poder ayuda a equilibrar factibilidad y rigor cient√≠fico   -->

---

## Componentes del poder

El poder depende de: 

- **Tama√±o del efecto**: qu√© tan grande es la diferencia verdadera  
- **Tama√±o de muestra (n)**: n√∫mero de unidades independientes  
- **Varianza (œÉ¬≤)**: variabilidad natural en el sistema  
- **Nivel de significancia (Œ±)**: usualmente 0.05  

---

## Poder y varianza: C√≥mo se conectan

- Recordar: El poder depende del tama√±o del efecto, tama√±o de muestra, varianza, y Œ±  
- En la pr√°ctica, **la varianza (œÉ¬≤)** est√° incorporada en el *tama√±o del efecto*  

Para una prueba t de dos muestras:  

$$
d = \frac{\text{diferencia de medias}}{\text{desviaci√≥n est√°ndar}}
$$

---

## Ejemplo: De varianza a poder

Supongamos que probamos sombreado vs sin sombreado en el crecimiento de algas:  

- Diferencia de medias esperada = **20 unidades**  
- Datos piloto: desviaci√≥n est√°ndar = **25**  
- Nivel de significancia Œ± = 0.05  
- Poder objetivo = 0.80  

$$
d = \frac{20}{25} = 0.8
$$

Pregunta: ¬øCu√°ntos arroyos r√©plica por tratamiento se necesitan?
---

## C√°lculo en R

```{r}
library(pwr)

# Tama√±o del efecto a partir de diferencia de medias y DE
d <- 20 / 25   # = 0.8

# An√°lisis de poder para prueba t de dos muestras
pwr.t.test(d = d, power = 0.8, sig.level = 0.05,
           type = "two.sample")
```

Resultado: ~26 r√©plicas por grupo necesarias

--- 

## Interpretaci√≥n

- Con œÉ = 25, detectar una diferencia de 20 unidades necesita ~26 r√©plicas por tratamiento.

- Si la variabilidad fuera menor (œÉ = 10):
    d = 20/10 = 2 ‚Üí muchas menos r√©plicas necesarias

- Si la variabilidad fuera mayor (œÉ = 40):
    d = 20/40 = 0.5 ‚Üí mucha m√°s replicaci√≥n necesaria

---

## Mensajes Clave {.dark-slide}

- Planificar el tama√±o de muestra antes del experimento  
- ¬°La varianza importa! Dicta qu√© tan grande se ve el efecto relativo al ruido.  
- Siempre tratar de estimar la varianza de estudios piloto o la literatura.  

---

## Bibliografia

Statistics done wrong: https://www.statisticsdonewrong.com/pseudoreplication.html

Marshall, D.J., 2024. Principles of experimental design for ecology and evolution. Ecology Letters, 27(4), p.e14400. [üìÑ PDF](../../refs/Marshall-2024.pdf)

Gotelli, N. J., & Ellison, A. M. (2004). A primer of ecological statistics (Vol. 1), Capitulo 4. Sunderland: Sinauer Associates. [üìÑ PDF](../../refs/Gotelli-2004-cap-4.pdf)

Gotelli, N. J., & Ellison, A. M. (2004). A primer of ecological statistics (Vol. 1), Capitulo 6. Sunderland: Sinauer Associates. [üìÑ PDF](../../refs/Gotelli-2004-cap-6.pdf)

---
